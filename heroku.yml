setup:
  addons:
    - heroku-postgresql:dev

build:
  docker:
    web: Dockerfile
    image: ${REGISTRY}/postgis:${VERSION}
    ports:
      - ${POSTGRES_PORT}:5432
    volumes:
      - postgres:/data/postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    restart: unless-stopped

run:
  command:
    - /bin/bash
    - -c
    - |
      set -e
      until psql -h ${POSTGRES_HOST} -U ${POSTGRES_USER} -d ${POSTGRES_DB} -c "select 1" > /dev/null 2>&1; do
        >&2 echo "Postgres is unavailable - sleeping"
        sleep 1
      done
      >&2 echo "Postgres is up - executing command"
      /bin/bash

